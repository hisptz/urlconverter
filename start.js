/**
 * Created by Vincent P. Minde  on 3/2/16.
 */
//Sample command nodejs start -url http://localhost:8080/dhis2 -dhis http://localhost:8080/dhis2 -u kmbwilo -p DHIS2014 -o /tmp/output.pdf -mu mailname -mp password -mh localhost

/**
 * Currently used command
 *
 *  sudo nodejs start -url https://hmisportal.moh.go.tz/fpportal/nationalPDF.html -dhis https://hmisportal.moh.go.tz/training -group "Family Planning Report" -u vincentminde -p Ilovemymum1 -o /tmp/output.pdf -mh localhost
 *
 */



var dhisServer = "http://localhost:8080/dhis2",
    username = "", password = "", mailUser = "", mailPassword = "", mailHost = "localhost", urlToConvert = "http://localhost:8080/dhis2", userGroup = "";
//Evaluate arguments
for (var index = 0; index < process.argv.length; index++) {
    var commandArgument = process.argv[index];
    if (commandArgument == "-dhis") {
        dhisServer = process.argv[index + 1];
    } else if (commandArgument == "-u") {
        username = process.argv[index + 1];
    } else if (commandArgument == "-p") {
        password = process.argv[index + 1];
    } else if (commandArgument == "-mu") {
        mailUser = process.argv[index + 1];
    } else if (commandArgument == "-mp") {
        mailPassword = process.argv[index + 1];
    } else if (commandArgument == "-mh") {
        mailHost = process.argv[index + 1];
    } else if (commandArgument == "-url") {
        urlToConvert = process.argv[index + 1];
    } else if (commandArgument == "-group") {
        userGroup = process.argv[index + 1];
    }
}

var attachments =  [];
function fetchUrl(url){
    var Promise = require('promise');
    return new Promise(function (resolve, reject) {
        var path = require('path')
        var childProcess = require('child_process')
        var phantomjs = require('phantomjs')
        var binPath = phantomjs.path;

        var date = new Date();
        var outputFile = "/tmp/report" + date.getFullYear() + "."  + (date.getMonth() + 1)+ "."  + date.getDay()+ "."  + date.getHours()+ "."  + date.getMinutes()+ "."  + date.getSeconds()+ "."  + date.getMilliseconds() + ".pdf"
        var childArgs = [
            path.join(__dirname, 'rasterize.js'),
            url,//'https://hmisportal.moh.go.tz/hmisportal/#/home',
            outputFile
        ];
        var postfixsever = require(__dirname + "/postfixsever");

        //Excecute phantomjs to convert url to
        childProcess.execFile(binPath, childArgs, function (err, stdout, stderr) {
            if (err) {
                console.log("Failed to fetch url:", err);
                reject();
            } else {
                console.log("Awesome fetch:");
                console.log(stdout);
                var resultJSON = JSON.parse(stdout);
                attachments.push({path: outputFile, type: "application/pdf", name: resultJSON.title + ".pdf"});
                resolve();
                //Fetch the group of user to get the report

            }
        });
    });
}

var emails = "";
function fetchUsers(){
    var request = require('request'),
        url = dhisServer + "/api/userGroups.json?filter=name:eq:" + userGroup + "&fields=users[email,name]",
        auth = "Basic " + new Buffer(username + ":" + password).toString("base64");
    var Promise = require('promise');
    return new Promise(function (resolve, reject) {
        request(
            {
                url: url,
                headers: {
                    "Authorization": auth
                }
            },
            function (error, response, body) {
                if (error) {
                    reject(error);
                    console.log(error);
                } else {
                    //Parse the body into json object
                    var json = JSON.parse(body);

                    var users = json.userGroups[0].users;
                    //Extract emails
                    for (var user in users) {
                        if (user == 0) {
                            emails = users[user].name + " <" + users[user].email + ">";
                        } else {
                            emails += ", " + users[user].name + " <" + users[user].email + ">";
                        }
                    }
                    console.log(emails);
                    resolve(emails);
                }

                // Do more stuff with 'body' here
            }
        );
    });
}

var Promise = require('promise');
var promises = [];
promises.push(fetchUsers());
var urls = urlToConvert.split(",");
for(var i in urlToConvert.split(",")){
    promises.push(fetchUrl(urls[i]));
}
Promise.all(promises)
    .then(function (res) {
        var postfixsever = require(__dirname + "/postfixsever");
        postfixsever.postfixSend(
            {
                user: mailUser,
                password: mailPassword,
                host: mailHost,
                ssl: false,
                port: 25
            },
            {
                msg: "Reports Generated By DHIS 2",
                from: "portal@hmisportal.moh.go.tz",
                to: emails,
                subject: "Sample Report",
                attachment: attachments
                /*attachment: [
                 {path: outputFile, type: "application/pdf", name: "report.pdf"}
                 ]*/
            }, function (result) {
                if (result) {
                    console.log("Mail Error", result);
                } else {
                    console.log("Awesome mails sent.");
                }

            }
        );
    });